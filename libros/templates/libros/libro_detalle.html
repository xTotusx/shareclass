{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}{{ libro.titulo }} | Detalle{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'libros/libro_detalle.css' %}">
    <style>
        /* Estilos espec√≠ficos para la secci√≥n de pr√©stamos */
        .loan-status-box {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(0,0,0,0.05);
            border-radius: 10px;
            border-left: 4px solid #185a9d;
        }
        .user-loan-active {
            background: #e8f5e9;
            border-left-color: #43cea2;
            color: #2e7d32;
        }
        .btn-action-loan {
            display: inline-block;
            width: 100%;
            padding: 12px 0;
            margin-top: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            text-decoration: none;
            transition: transform 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn-borrow { background: #185a9d; color: white; }
        .btn-return { background: #43cea2; color: white; }
        .btn-disabled { background: #ccc; color: #666; cursor: not-allowed; }
        
        .btn-action-loan:hover { transform: translateY(-2px); opacity: 0.9; }

        /* Lista de historial para Admin */
        .admin-history {
            margin-top: 2rem;
            border-top: 1px solid rgba(0,0,0,0.1);
            padding-top: 1rem;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            font-size: 0.9rem;
        }
        .status-dot {
            height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="main-container">
    <a href="{% url 'libros_home' %}" class="btn-back">‚Üê Volver al Inventario</a>
    
    <div class="detail-container">
        <div class="detail-img">
            {% if libro.imagen %}
                <img src="{{ libro.imagen.url }}" alt="{{ libro.titulo }}">
            {% else %}
                <span class="no-cover-text">Sin portada</span>
            {% endif %}
        </div>
        
        <div class="detail-info">
            <h1 class="detail-title">{{ libro.titulo }}</h1>
            <p class="detail-author">por {{ libro.autor }}</p>
            
            <div class="meta-data">
                <p class="desc-label"><strong>Descripci√≥n:</strong></p>
                <p class="desc-text">
                    {% if libro.descripcion %}
                        {{ libro.descripcion }}
                    {% else %}
                        No hay descripci√≥n disponible.
                    {% endif %}
                </p>
            </div>

            <div class="stock-box">
                Stock Disponible: <strong>{{ libro.stock }}</strong> unidades
            </div>

            <div class="loan-section">
                
                {% for prestamo in libro.prestamos.all %}
                    {% if prestamo.usuario == request.user and not prestamo.devuelto %}
                        
                        <div class="loan-status-box user-loan-active">
                            <p style="margin:0; font-weight:bold;">üìñ Tienes este libro en tu poder.</p>
                            <small>Desde: {{ prestamo.fecha_prestamo|date:"d M Y" }}</small>
                            
                            <a href="{% url 'devolver_libro' prestamo.id %}" class="btn-action-loan btn-return">
                                Devolver Libro
                            </a>
                        </div>
                        
                        <style>.btn-borrow-wrapper { display: none; }</style> 
                        
                    {% endif %}
                {% endfor %}

                <div class="btn-borrow-wrapper">
                    {% if libro.stock > 0 %}
                        <a href="{% url 'prestar_libro' libro.id %}" class="btn-action-loan btn-borrow">
                            üôã‚Äç‚ôÇÔ∏è Tomar Prestado
                        </a>
                    {% else %}
                        <button class="btn-action-loan btn-disabled" disabled>
                            üö´ Agotado Temporalmente
                        </button>
                    {% endif %}
                </div>

            </div>

            {% if is_admin %}
            <div class="admin-history">
                <h4 style="color:#185a9d; margin-bottom:10px;">üìã Estado de Pr√©stamos (Admin)</h4>
                
                {% if libro.prestamos.all %}
                    <div style="max-height: 150px; overflow-y: auto;">
                        {% for p in libro.prestamos.all %}
                        <div class="history-item">
                            <div>
                                {% if not p.devuelto %}
                                    <span class="status-dot" style="background:red;" title="No devuelto"></span>
                                {% else %}
                                    <span class="status-dot" style="background:#ccc;" title="Devuelto"></span>
                                {% endif %}
                                <strong>{{ p.usuario.username }}</strong>
                            </div>
                            <div style="color:#666; font-size:0.8rem;">
                                {% if p.devuelto %}
                                    Devuelto: {{ p.fecha_devolucion|date:"d/m/Y" }}
                                {% else %}
                                    <span style="color:red; font-weight:bold;">En posesi√≥n</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p style="color:#999; font-style:italic; font-size:0.9rem;">No hay registros de pr√©stamos.</p>
                {% endif %}

                <div class="admin-actions">
                    <a href="{% url 'libro_editar' libro.id %}" class="btn btn-edit">‚úèÔ∏è Editar</a>
                    <a href="{% url 'libro_eliminar' libro.id %}" class="btn btn-delete" 
                       onclick="return confirm('¬øSeguro que quieres borrar este libro?');">üóëÔ∏è Eliminar</a>
                </div>
            </div>
            {% endif %}

        </div>
    </div>
</div>
{% endblock %}